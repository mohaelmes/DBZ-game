<!DOCTYPE html>
<html lang="es">
<head>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G8KE6JEFC2"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-G8KE6JEFC2');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selecciona tu Jugador - Retro Dragon Ball Universe</title>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<style>/* Importando fuente retro */
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    
    /* Estilo global */
    body {
        font-family: 'Press Start 2P', cursive;
        background-color: #2c3e50;
        color: #ecf0f1;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        flex-direction: column;
        box-sizing: border-box;
    }
    
    /* Contenedor principal */
    .container {
        background-color: #34495e;
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 0 25px rgba(0, 0, 0, 0.7);
        width: 100%;
        max-width: 700px;
        text-align: center;
        margin-top: 20px;
    }
    
    /* Estilo del encabezado */
    header {
        background-color: #f39c12;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    
    h1 {
        font-size: 2rem;
        color: #2c3e50;
        text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
        margin: 0;
    }
    
    /* Botón de logout */
    #logout-button {
        background-color: #e74c3c;
        color: #fff;
        border: none;
        padding: 10px 20px;
        font-size: 1.2rem;
        cursor: pointer;
        border-radius: 5px;
        transition: background-color 0.3s ease;
        margin-bottom: 20px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    
    #logout-button:hover {
        background-color: #c0392b;
    }
    
    /* Sección de personajes */
    .character-section {
        margin-top: 20px;
    }
    
    .character-section h2 {
        font-size: 1.5rem;
        color: #f1c40f;
        margin-bottom: 20px;
    }
    
    /* Estilo de los personajes (grid) */
    .characters-grid {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
    }
    
    .character-card {
        background-color: #34495e;
        border-radius: 10px;
        padding: 15px;
        margin: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.4);
        width: 250px;
        text-align: center;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .character-card img {
        width: 100%;
        height: auto;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.4);
    }
    
    .character-card h3 {
        color: #f1c40f;
        margin-top: 15px;
        font-size: 1.2rem;
        text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);
    }
    
    .character-card p {
        color: #ecf0f1;
        font-size: 1rem;
        margin-bottom: 15px;
    }
    
    .character-card button {
        background-color: #f39c12;
        color: #2c3e50;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
        transition: background-color 0.3s ease;
    }
    
    .character-card button:hover {
        background-color: #e67e22;
    }
    
    .character-card button.btn-danger {
        background-color: #e74c3c;
    }
    
    .character-card button.btn-danger:hover {
        background-color: #c0392b;
    }
    
    /* Formulario de creación y edición */
    #create-character-form {
        background-color: #34495e;
        border-radius: 10px;
        padding: 20px;
        margin-top: 30px;
    }
    
    #form-heading {
        color: #f1c40f;
        margin-bottom: 20px;
    }
    
    .form-group label {
        color: #ecf0f1;
        font-size: 1rem;
        display: block;
        margin-bottom: 10px;
    }
    
    .form-control {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        background-color: #34495e;
        color: #fff;
        border: 2px solid #f39c12;
        border-radius: 5px;
        font-size: 1rem;
        text-align: center;
    }
    
    .form-control:focus {
        border-color: #e67e22;
        outline: none;
    }
    
    button[type="submit"] {
        background-color: #f39c12;
        color: #2c3e50;
        padding: 15px;
        width: 100%;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.2rem;
    }
    
    button[type="submit"]:hover {
        background-color: #e67e22;
    }
    
    input[type="hidden"] {
        display: none;
    }
    
    /* Pie de página */
    footer {
        background-color: #2c3e50;
        padding: 10px;
        text-align: center;
        width: 100%;
        margin-top: 20px;
        color: #ecf0f1;
    }
    
    /* Efecto hover retro */
    button, .btn-danger, .btn-warning {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    button:hover, .btn-danger:hover, .btn-warning:hover {
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    
    /* Responsividad */
    @media (max-width: 768px) {
        .container {
            padding: 20px;
            margin-top: 10px;
        }
    
        .character-card {
            width: 100%;
        }
    }
    </style>
<body>
    <div class="container">
        <!-- Encabezado -->
        <header class="text-center py-4 bg-warning">
            <h1>Selecciona tu Jugador</h1>
        </header>

        <button id="logout-button" class="btn btn-danger" aria-label="Cerrar sesión">Logout</button>

        <!-- Sección de usuarios conectados -->
        <section id="connected-users" aria-labelledby="connected-users-heading">
            <h3 id="connected-users-heading">Usuarios Conectados</h3>
            <ul id="users-list">
                <!-- Usuarios conectados se agregarán aquí dinámicamente -->
            </ul>
        </section>
       
        <!-- Sección de selección de personajes -->
        <section class="character-section my-5" aria-labelledby="character-selection-heading">
            <h2 id="character-selection-heading">Elige tu Guerrero Z</h2>
            <div class="characters-grid row" role="group" aria-labelledby="character-selection-heading">
                <!-- Personajes se agregarán aquí dinámicamente -->
            </div>
        </section>

        <!-- Formulario para crear o editar personajes -->
        <section class="mt-5">
            <!-- Botón para mostrar el formulario de creación de personaje -->
            <button id="show-create-form" class="btn btn-primary mb-3">Crear Personaje</button>
        
            <!-- Formulario de creación de personaje, inicialmente oculto -->
            <div id="create-character-form-container" style="display: none;">
                <h3 id="form-heading">Crea o Edita un Personaje</h3>
                <form id="create-character-form" class="mt-3">
                    <div class="form-group">
                        <label for="name">Nombre del personaje</label>
                        <input type="text" id="name" class="form-control" placeholder="Nombre del personaje" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Descripción del personaje</label>
                        <input type="text" id="description" class="form-control" placeholder="Descripción del personaje" required>
                    </div>
                    <div class="form-group">
                        <label for="image">Selecciona una imagen para el personaje</label>
                        <select id="image" class="form-control" required>
                            <option value="goku.png">Goku</option>
                            <option value="vegeta.png">Vegeta</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Personaje</button>
                    <input type="hidden" id="edit-id" value="" />
                </form>
            </div>
        </section>
        
        <!-- Pie de página -->
        <footer class="text-center mt-5 py-3 bg-dark text-white">
            <p>© 2024 Retro Dragon Ball Universe - All Rights Reserved</p>
        </footer>
    </div>
    <script src="/socket.io/socket.io.js"></script>

    <script>
        // Cargar los personajes desde el archivo JSON
        const socket = io();
        const getUserCharacters = () => {
            const sessionUserId = sessionStorage.getItem('userId');
            console.log("Este es el userId", sessionUserId);
            if (!sessionUserId) {
                console.error('Usuario no autenticado.');
                return;
            }
    
            $.get('characters.json', function(characters) {
                if (Array.isArray(characters) && characters.length > 0) {
                    const userCharacters = characters.filter(character => character.userId == sessionUserId);
                    console.log("Estos son los usercharacters:", userCharacters);
                    $('.characters-grid').empty();
                    userCharacters.forEach(character => {
                        const imageUrl = `/images/${character.image}`;
                        $('.characters-grid').append(`
                            <div class="col-md-4 character-card text-center">
                                <img src="${imageUrl}" alt="${character.name}" class="img-fluid">
                                <h3>${character.name}</h3>
                                <p>${character.description}</p>
                                <button class="btn btn-warning" data-character='${JSON.stringify(character)}' onclick="selectCharacter(this)">Seleccionar/Ver mapa</button>
                                <button class="btn btn-danger" onclick="deleteCharacter(${character.id})">Eliminar</button>
                                <button class="btn btn-info" onclick="editCharacter(${character.id})">Editar</button>
                            </div>
                        `);
                    });
                } else {
                    console.warn('No se encontraron personajes para este usuario.');
                }
            }).fail(function(error) {
                console.error("Error al obtener personajes:", error);
            });
        };
    
        // Función para seleccionar un personaje
        function selectCharacter(button) {
    const character = JSON.parse($(button).attr('data-character'));
    const username = sessionStorage.getItem('userName');
    const characterKey = `${username}_${character.name}`;  // Crear una clave única
    
    // Intentar recuperar la posición guardada del personaje desde localStorage
    const existingData = JSON.parse(localStorage.getItem(characterKey));
    const position = existingData ? existingData.position : { x: 100, y: 100 };  // Usar posición guardada o la inicial

    
    // Guardar el personaje seleccionado con la clave única en localStorage
    localStorage.setItem(characterKey, JSON.stringify({
        character: character,
        position: position  // Usar posición recuperada o la inicial si no existía
    }));

    // Guardar el personaje seleccionado en sessionStorage para la sesión actual
    sessionStorage.setItem('selectedCharacter', JSON.stringify(character));
    sessionStorage.setItem('selectedCharacterName', character.name); // Guardar el nombre del personaje para identificarlo fácilmente

    alert(`Has seleccionado a ${character.name}. ¡Comenzando juego!`);
    window.location.href = 'game.html';
}

    
        // Eliminar un personaje
        function deleteCharacter(characterId) {
            $.ajax({
                url: `/api/characters/${characterId}`,  // El ID del personaje se pasa en la URL
                type: 'DELETE',
                success: function(response) {
                    alert('Personaje eliminado con éxito');
                    getUserCharacters();  // Recargar la lista de personajes después de eliminar
                },
                error: function(error) {
                    console.error('Error al eliminar personaje:', error);
                    alert('Hubo un problema al eliminar el personaje');
                }
            });
        }
    
        // Cargar datos de personaje en formulario para editar
        function editCharacter(characterId) {
            $.get(`/api/characters/${characterId}`, function(character) {
                if (character) {
                    $('#name').val(character.name);
                    $('#description').val(character.description);
                    $('#image').val(character.image);
                    $('#edit-id').val(character.id); // Guardamos el id del personaje para la edición
                    $('#form-heading').text('Editar Personaje');
                } else {
                    alert('Personaje no encontrado');
                }
            });
        }
    
        // Guardar un personaje (crear o editar)
        $('#create-character-form').submit(function(e) {
            e.preventDefault();
    
            const name = $('#name').val();
            const description = $('#description').val();
            const image = $('#image').val();
            const editId = $('#edit-id').val();
    
            // Obtener el userId desde sessionStorage
            const userId = sessionStorage.getItem('userId'); 
    
            // Asegurarse de que el userId esté presente
            if (!userId) {
                alert('No se encontró el userId. Asegúrate de estar autenticado.');
                return; // Salir si no se encuentra el userId
            }
    
            const newCharacter = { 
                name, 
                description, 
                image,
                userId  // Añadir el userId al objeto
            };
    
            if (editId) {
                // Si hay un ID de edición, se trata de una actualización
                $.ajax({
                    url: `/api/characters/${editId}`,
                    type: 'PUT',
                    contentType: 'application/json',
                    data: JSON.stringify(newCharacter),  // Mandamos el nuevo personaje con el userId
                    success: function(response) {
                        alert('Personaje editado con éxito');
                        getUserCharacters(); // Recargar la lista después de editar
                    },
                    error: function(error) {
                        console.error('Error al editar personaje:', error);
                        alert('Hubo un problema al editar el personaje');
                    }
                });
            } else {
                // Si no hay ID, es un nuevo personaje
                $.ajax({
                    url: '/api/characters',
                    type: 'POST',
                    contentType: 'application/json',  // Aseguramos que el servidor reciba JSON
                    data: JSON.stringify(newCharacter),  // Mandamos el nuevo personaje con el userId
                    success: function(response) {
                        alert('Personaje creado con éxito');
                        getUserCharacters(); // Recargar la lista después de crear
                    },
                    error: function(error) {
                        console.error('Error al crear personaje:', error);
                        alert('Hubo un problema al guardar el personaje');
                    }
                });
            }
        });
    
        // Cargar la lista de usuarios conectados
        function loadOnlineUsers() {
            $.get('/api/online-users', function(users) {
                // Limpiar la lista antes de agregar los usuarios
                $('#users-list').empty();
    
                if (Array.isArray(users) && users.length > 0) {
                    users.forEach(user => {
                        $('#users-list').append(`
                            <li class="user-item">${user.name}</li>
                        `);
                    });
                } else {
                    $('#users-list').append('<li>No hay usuarios conectados</li>');
                }
            }).fail(function(error) {
                console.error('Error al obtener los usuarios:', error);
                $('#users-list').append('<li>Error al obtener usuarios</li>');
            });
        }
    
        // Función de logout
        function logout() {
        const username = sessionStorage.getItem('username');
        const userId = sessionStorage.getItem('userId');
        
        if (!username || !userId) {
            console.error("Usuario no autenticado.");
            return;
        }

        // Emitir el evento de logout al servidor a través de socket.io
        socket.emit('logout', username);
        console.log('Emitido logout para el usuario:', username);

        // Eliminar al usuario de la lista de usuarios en línea en la API
        $.ajax({
            url: `/api/online-users/${userId}`, // El endpoint que elimine al usuario
            type: 'DELETE',
            success: function(response) {
                console.log("Usuario eliminado de la lista de usuarios en línea");
            },
            error: function(error) {
                console.error("Error al eliminar el usuario de la lista de usuarios en línea", error);
            }
        });

        // Eliminar datos de sessionStorage
        sessionStorage.removeItem('userId');
        sessionStorage.removeItem('username');

        // Redirigir al login
        window.location.href = 'login.html';
    }
    
        $(document).ready(function() {
            // Mostrar u ocultar el formulario de creación de personaje
            $('#show-create-form').click(function() {
                $('#create-character-form-container').toggle(); // Cambiar la visibilidad del formulario
            });
    
            // Verificar si el usuario está autenticado
            const userId = sessionStorage.getItem('userId');
            if (!userId) {
                // Si no hay un usuario autenticado, redirigir al login
                window.location.href = 'login.html';
                return;
            }
    
            // Cargar los personajes del usuario si está autenticado
            getUserCharacters();
            
            // Cargar la lista de usuarios conectados cada 2 segundos
            setInterval(loadOnlineUsers, 2000);
            loadOnlineUsers();
    
            // Asociar el botón de logout con la función logout
            $('#logout-button').click(logout);
        });
    </script>
    
</body>
</html>
